from buildbot.plugins import *
from cfg import config

srcs, sches, builders = [], [], []
for src in config['srcs']:
    source = config['svn'] % src
    srcs.append(
        changes.SVNPoller(
            repourl=source,
            project=src,
            svnuser=config['user'],
            svnpasswd=config['pass'],
            pollInterval=config['poll'],
            split_file=util.svn.split_file_alwaystrunk,
        )
    )

    sches.append(
        schedulers.SingleBranchScheduler(
            name=src,
            change_filter=util.ChangeFilter(project=src),
            treeStableTimer=None,
            builderNames=[src],
        )
    )

    cmds = [
        steps.SVN(
            repourl=source,
            mode="full",
            username=config['user'],
            password=config['pass'],
            haltOnFailure=True,
        ),
    ]

    for cmd in config['cmds']:
        cmds.append(steps.ShellCommand(command=cmd, haltOnFailure=True))

    builders.append(
        util.BuilderConfig(
            name=src,
            workernames=["worker"],
            factory=util.BuildFactory(cmds)
        )
    )

BuildmasterConfig = {
    'services': [],
    'title': "oriole test.",
    'titleURL': '',
    'buildbotURL': "http://localhost:8000/",
    'www': dict(port=8000, plugins=dict(waterfall_view={}, console_view={}, grid_view={})),
    'db': {'db_url': "sqlite:///state.sqlite"},
    'protocols': {'pb': {'port': 9989}},
    'workers': [worker.Worker("worker", "worker")],
    'change_source': srcs,
    'schedulers': sches,
    'builders': builders,
}
